# LinxISA v0.3 â€” QEMU / Emulator Trap & Decode Contracts

This reference captures v0.3 trap/reporting contracts that QEMU must implement.

Canonical source-of-truth lives in **linx-isa**:
- `docs/architecture/isa-manual/src/chapters/09_system_and_privilege.adoc`
- `docs/architecture/isa-manual/src/chapters/04_block_isa.adoc`
- `docs/bringup/plan/isa_clarifications.md`

---

## 1) TRAPNO layout (keep existing QEMU layout)

- `TRAPNO.CAUSE` is a 24-bit field stored at `TRAPNO[47:24]`
- `TRAPNO.TRAPNUM` is at `TRAPNO[5:0]`

---

## 2) v0.3 E_BLOCK cause encoding (within TRAPNO.CAUSE)

Within the 24-bit `TRAPNO.CAUSE` field:

- `CAUSE[15:8] = EC` (E_BLOCK cause)
- `CAUSE[7:4]` reserved (0)
- `CAUSE[3:0] = kind` (used by EC_CFI)

E_BLOCK EC values:
- `EC_CFI = 0x1`
- `EC_BLOCKFMT = 0x2`
- `EC_BFETCH = 0x3`

EC_CFI kinds:
- `0x1 = CFI_BAD_TARGET`
- `0x3 = CFI_MISSING_NEXT_MARKER`

---

## 3) E_BLOCK(EC_CFI) reporting

- `TRAPARG0 = source PC/TPC`
- `BI = 0`
- precise

---

## 4) E_BLOCK(EC_BLOCKFMT) reporting

- `EC_BLOCKFMT = 0x2`
- `TRAPARG0[7:0] = MissingDescFamily`:
  - `0 = B.* generic`
  - `1 = B.DIM`
  - `2 = B.TEXT`
  - `3 = B.ARG`
  - `4 = B.IOR`
  - `5 = B.IOT/B.IOTI`
- `TRAPARG0[15:8] = MissingDetail`:
  - `0x00 missing`
  - `0x01 invalid/out-of-range`
  - `0x02 illegal combination`

Rules:
- header-time validation before side effects
- `BI=0`, precise

---

## 5) Body fetch faults

Split policy:
- MMU translation/access faults during body fetch/execute => `E_DATA` (BI=1 context)
- non-MMU body fetch fault (e.g. misaligned body entry) => `E_BLOCK(EC_BFETCH=0x3)`

For `E_BLOCK(EC_BFETCH)`:
- `TRAPARG0 = fault VA`
- `BI = 1`
- misalignment faults are fatal

---

## 6) Body illegal instructions

- Illegal instruction/encoding in a block body is `E_INST(EC_ILLEGAL)` with `BI=1`.

---

## 7) Practical implementation note

Avoid touching `roms/*` submodules when editing QEMU; constrain commits to `target/linx/*`.
