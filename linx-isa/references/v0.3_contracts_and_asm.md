# LinxISA v0.3 — Contracts, Encodings, and Assembler Conventions

This reference captures **stable v0.3 decisions** that must remain consistent across:

- ISA manual + `isa/v0.3/` catalogs
- LLVM (AsmParser/ISel/InstPrinter/whitelists)
- QEMU (decode/execute + trap reporting)

It is intentionally concise and points to canonical sources in `linx-isa`.

---

## 1) Block markers and “outside blocks”

- `BSTART.*` / `BSTOP` are **block boundary markers** for init/commit.
- “No architectural instructions outside blocks” means: no **architectural state-modifying payload** outside block
  execution; marker/descriptor packaging is allowed.

Canonical: `docs/architecture/isa-manual/src/chapters/04_block_isa.adoc`

---

## 2) Control-flow integrity (CFI) trap contract

### 2.1 E_BLOCK(EC_CFI) encoding

- `E_BLOCK(EC_CFI)` with `EC_CFI = 0x1` (within the E_BLOCK cause space).
- `EC_CFI_KIND` is encoded in `TRAPNO.CAUSE[3:0]`:
  - `0x1 = CFI_BAD_TARGET`
  - `0x3 = CFI_MISSING_NEXT_MARKER`
- `TRAPNO.CAUSE[7:4]` reserved (0).

### 2.2 Reporting

- `TRAPARG0 = source PC/TPC` (instruction or marker that triggered violation)
- `BI = 0`
- precise

Canonical: `docs/architecture/isa-manual/src/chapters/09_system_and_privilege.adoc`

---

## 3) Block-format validation trap contract

### 3.1 E_BLOCK(EC_BLOCKFMT)

- `EC_BLOCKFMT = 0x2` (within E_BLOCK)
- Used for missing/invalid/illegal-combination header descriptor requirements.

### 3.2 TRAPARG0 encoding

- `TRAPARG0[7:0] = MissingDescFamily`
  - `0 = B.* (generic descriptor stream / non-family-specific)`
  - `1 = B.DIM`
  - `2 = B.TEXT`
  - `3 = B.ARG`
  - `4 = B.IOR`
  - `5 = B.IOT/B.IOTI`
- `TRAPARG0[15:8] = MissingDetail`
  - `0x00` missing
  - `0x01` invalid/out-of-range
  - `0x02` illegal combination

Other rules:
- header-time validation before side effects
- report exactly one missing family if multiple; priority order:
  1) `B.ARG` 2) `B.TEXT` 3) `B.IOT/IOTI` 4) `B.IOR` 5) `B.DIM`

Canonical: `docs/architecture/isa-manual/src/chapters/09_system_and_privilege.adoc`

---

## 4) Body fetch faults

- `EC_BFETCH = 0x3` (within E_BLOCK)
- Split policy:
  - MMU translation/access fault during body fetch/execute => `E_DATA` (BI=1 context)
  - non-MMU body fetch fault (e.g. misaligned body entry) => `E_BLOCK(EC_BFETCH)`
- Alignment:
  - decoupled `BodyTPC` (legacy name) is the body-entry `TPC`, must be 2-byte aligned
  - SIMT `B.TEXT` targets must be 2-byte aligned
- Misalignment `EC_BFETCH` is **fatal** (non-restartable)

Canonical: `docs/architecture/isa-manual/src/chapters/09_system_and_privilege.adoc`, `04_block_isa.adoc`, `07_tile_blocks.adoc`

---

## 5) TPC terminology

- `TPC` is **Temporary PC** (not Thread PC)
- `BodyTPC` is legacy prose name for the body-entry `TPC`

Canonical: `docs/architecture/isa-manual/src/chapters/02_programming_model.adoc`

---

## 6) SIMT body terminators

- SIMT out-of-line bodies (decoupled/SIMT vector) may terminate on first terminator marker.
- Valid terminators: `BSTOP/C.BSTOP` and `BSTART.*/C.BSTART.*`.
- `BSTART` inside body is a **terminator trigger only**, not an in-body successor.

Canonical: `04_block_isa.adoc` and `07_tile_blocks.adoc`

---

## 7) TEPL / TileOp10 encoding contract (assembler-visible)

### 7.1 Canonical encodings that changed

- `TCOLEXPAND = 0x0C0` (strict v0.3)
- `TROWEXPAND = 0x0C1` (strict v0.3)
- legacy `0x027` is **non-canonical**; strict toolchains reject it.

### 7.2 TOPS (tile-scalar) encodings (kind=0x1, func mirrors tile-tile)

- `TADDS=0x040`, `TSUBS=0x041`, `TMULS=0x042`, `TDIVS=0x043`, `TMAXS=0x044`, `TMINS=0x045`,
  `TANDS=0x046`, `TORS=0x047`, `TXORS=0x048`, `TSHLS=0x049`, `TSHRS=0x04A`.

Scalar RHS conventions (TOPS):
- scalar RHS comes from `B.IOR` (required), broadcast to all elements
- scalar RHS type/signedness matches tile element dtype; extraction is low-bit truncation
- `B.ARG` may be present but does not affect scalar RHS

Canonical: `docs/architecture/isa-manual/src/chapters/04_block_isa.adoc`, `isa/v0.3/state/engine_ops.json`

---

## 8) Mandatory descriptor contracts by tile/vector block type

See the dedicated manual chapter:
- `docs/architecture/isa-manual/src/chapters/07_tile_blocks.adoc`

---

## 9) Bring-up status tracking and encoding checks

- TEPL semantic catalog seed: `isa/v0.3/state/engine_ops.json`
- Bring-up status file: `docs/bringup/tepl_status.yaml`
- Encoding consistency gate (manual run for now): `tools/bringup/check_tepl_encoding.py`

---

## Practical guidance when updating LLVM/QEMU

- Prefer changing aliases/whitelists/InstPrinter to match strict v0.3 numeric encodings.
- Avoid touching QEMU `roms/*` submodules; restrict commits to `target/linx/*`.
